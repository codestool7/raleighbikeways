<html>

<head>
    <title>Raleigh Bikeways</title>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Lato', sans-serif;
        }

        #map {
            position: absolute;
            top: 75px;
            bottom: 0px;
            width: 100%;
        }

        #header {
            position: flex;
            top: 0;
            height: 75px;
            width: 100%;
            background: whitesmoke;
        }

        #title {
            display: inline-block;
            padding: 20px;
            font-size: 28px;
        }

        #sources {
            float: right;
            padding: 25px;
        }

        #sources span {
            text-transform: uppercase;
            color: #888;
            font-size: 14px;
        }

        #sources a {
            padding-left: 10px;
            text-decoration: none;
            color: #444;
        }

        #sources a:hover {
            color: #000;
        }

        #footer {
            position: absolute;
            height: 80px;
            bottom: 0;
            width: 100%;
            background: whitesmoke;
        }

        #keyTitle {
            background: #2c2c2c;
            height: 30px;
            font-weight: bold;
            text-align: center;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.6em;
            box-sizing: border-box;
            padding: 6px;
            font-size: 13px;
        }

        #key {
            height: 50px;
            display: flex;
            justify-content: space-evenly;
        }

        .keyEle {
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: white;
            padding: 15px;
            font-size: 14px;
            font-weight: bold;
            flex-grow: 1;
            box-sizing: border-box;
            height: 50px;
            width: 300px;
        }

        #legend {
            position: absolute;
            margin: 10px;
            z-index: 5;
        }

        #legend > div > i {
            cursor: pointer;
        }

        #legend > #legend-box {
            width: auto;
            height: fit-content;
            background-color: gray;
            padding: 20px;
            visibility: hidden;
            font-size: 24px;
        }

        #legend-box td {
            padding-bottom: 30px;
            font-size: 30px;
            padding-left: 20px;
        }

        #legend-box .legend-checkbox{
            transform: scale(3);
            margin-right: 20px;
            cursor: pointer;
        }

        #existing {
            background: #eee;
            color: black;
        }

        #greenways {
            background: #28B463;
        }
    
        #programmed {
            background: #3498DB;
        }

        #citrix {
            background: #f9423a;
        }
        
        .mapboxgl-ctrl-group > button{
            width: 50px !important;
            height: 50px !important;
        }

        .mapboxgl-ctrl-geolocate > button{
            width: 50px !important;
            height: 50px !important;
        }

        .mapboxgl-ctrl-bottom-right .mapboxgl-ctrl-group {
            margin: 0 30px 30px 0 !important;
        }

        .mapboxgl-ctrl-top-right .mapboxgl-ctrl {
            margin: 30px 30px 0 0 !important;
        }

        .greenway-legend {
            stroke: #28B463;
            stroke-width: 8;
            padding-top: 5px;
        }

        .existing-legend {
            stroke: #eee;
            stroke-width: 8;
            padding-top: 5px;
        }

        .programmed-legend {
            stroke: #3498DB;
            stroke-width: 8;
            padding-top: 5px;
        }

        /* Meterial Icons Styles */
        .material-icons.md-18 { font-size: 18px; }
        .material-icons.md-24 { font-size: 24px; }
        .material-icons.md-36 { font-size: 36px; }
        .material-icons.md-48 { font-size: 48px; }
        .material-icons.md-dark { color: rgba(0, 0, 0, 0.54); }
        .material-icons.md-dark.md-inactive { color: rgba(0, 0, 0, 0.26); }
        .material-icons.md-light { color: rgba(255, 255, 255, 1); }
        .material-icons.md-light.md-inactive { color: rgba(255, 255, 255, 0.3); }

        .noselect {
            -webkit-touch-callout: none; /* iOS Safari */
            -webkit-user-select: none; /* Safari */
            -khtml-user-select: none; /* Konqueror HTML */
            -moz-user-select: none; /* Old versions of Firefox */
            -ms-user-select: none; /* Internet Explorer/Edge */
            user-select: none; /* Non-prefixed version, currently
                                        supported by Chrome, Opera and Firefox */
        }
    </style>

    <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.52.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.52.0/mapbox-gl.css' rel='stylesheet' />
</head>

<body>
    <div id="header">
        <div id="title">Raleigh Bikeways</div>
        <div id="sources">
            <span>Sources (all from municipal data)</span>
            <a href="https://services.arcgis.com/v400IkDOw1ad7Yad/ArcGIS/rest/services/Existing_Bike_Facilities/FeatureServer" target="_blank">Existing</a>
            <a href="https://services.arcgis.com/v400IkDOw1ad7Yad/ArcGIS/rest/services/Programmed_Bike_Facilities/FeatureServer" target="_blank">Programmed</a>
            <a href="https://services.arcgis.com/v400IkDOw1ad7Yad/arcgis/rest/services/Greenway_Trails_All/FeatureServer" target="_blank">Greenways</a>
            <a href="https://services.arcgis.com/v400IkDOw1ad7Yad/arcgis/rest/services/Citrix_Cycle_Stations/FeatureServer" target="_blank">Citrix Cycle Stations</a>
        </div>
    </div>
    <div id="legend">
        <div onclick="toggleLegend()">
            <i class="material-icons md-48 md-light noselect">layers</i>
        </div>
        <div id="legend-box">
            <table>
                <tr>
                    <td>
                        <input type="checkbox" class="legend-checkbox" onchange="legendToggleLayer(this)" name="existing-greenways-layer" checked>Greenways<br>        
                    </td>
                    <td>
                        <svg height="10" width="100" class="greenway-legend">
                            <line x1="0" y1="5" x2="100" y2="5"/>
                        </svg>
                    </td>
                </tr>
                <tr>
                    <td>
                        <input type="checkbox" class="legend-checkbox" onchange="legendToggleLayer(this)" name="existing-greenways-dashed-layer" checked>Marginal Greenways<br>
                    </td>
                    <td>
                        <svg height="10" width="100" class="greenway-legend">
                            <line x1="0" y1="5" x2="20" y2="5"/>
                            <line x1="40" y1="5" x2="60" y2="5"/>
                            <line x1="80" y1="5" x2="100" y2="5"/>
                        </svg>
                    </td>
                </tr>
                <tr>
                    <td>
                        <input type="checkbox" class="legend-checkbox" onchange="legendToggleLayer(this)" name="programmed-bike-facilities-layer" checked>Planned Bikeways<br>
                    </td>
                    <td>
                        <svg height="10" width="100" class="programmed-legend">
                            <line x1="0" y1="5" x2="100" y2="5"/>
                        </svg>
                    </td>
                </tr>
                <tr>
                    <td>
                        <input type="checkbox" class="legend-checkbox" onchange="legendToggleLayer(this)" name="programmed-bike-facilities-dashed-layer" checked>Planned Recommended Paths<br>
                    </td>
                    <td>
                        <svg height="10" width="100" class="programmed-legend">
                            <line x1="0" y1="5" x2="20" y2="5"/>
                            <line x1="40" y1="5" x2="60" y2="5"/>
                            <line x1="80" y1="5" x2="100" y2="5"/>
                        </svg>
                    </td>
                </tr>
                <tr>
                    <td>
                        <input type="checkbox" class="legend-checkbox" onchange="legendToggleLayer(this)" name="existing-bike-facilities-layer" checked>Bikeways<br>
                    </td>
                    <td>
                        <svg height="10" width="100" class="existing-legend">
                            <line x1="0" y1="5" x2="100" y2="5"/>
                        </svg>
                    </td>
                </tr>
                <tr>
                    <td>
                        <input type="checkbox" class="legend-checkbox" onchange="legendToggleLayer(this)" name="existing-bike-facilities-dashed-layer" checked>Recommended Paths<br>
                    </td>
                    <td>
                        <svg height="10" width="100" class="existing-legend">
                            <line x1="0" y1="5" x2="20" y2="5"/>
                            <line x1="40" y1="5" x2="60" y2="5"/>
                            <line x1="80" y1="5" x2="100" y2="5"/>
                        </svg>
                    </td>
                </tr>
                <tr>
                    <td>
                        <input type="checkbox" class="legend-checkbox" onchange="legendToggleLayer(this)" name="citrix-cycle-stations-layer" checked>Citrix Cycle Stations<br>
                    </td>
                    <td>
                        <svg height="24" width="24" class="existing-legend">
                                <circle cx="12" cy="12" r="10" stroke="black" stroke-width="2" fill="red" />
                        </svg>
                    </td>
                </tr>
            </table>
            <!-- <div id="legend-checkboxes">
                <input type="checkbox" onchange="legendToggleLayer(this)" name="existing-greenways-layer" checked>Greenways<br>
                <input type="checkbox" onchange="legendToggleLayer(this)" name="existing-greenways-dashed-layer" checked>Marginal Greenways<br>
                <input type="checkbox" onchange="legendToggleLayer(this)" name="programmed-bike-facilities-layer" checked>Planned Bikeways<br>
                <input type="checkbox" onchange="legendToggleLayer(this)" name="programmed-bike-facilities-dashed-layer" checked>Planned Recommended Paths<br>
                <input type="checkbox" onchange="legendToggleLayer(this)" name="existing-bike-facilities-layer" checked>Bikeways<br>
                <input type="checkbox" onchange="legendToggleLayer(this)" name="existing-bike-facilities-dashed-layer" checked>Recommended Paths<br>
                <input type="checkbox" onchange="legendToggleLayer(this)" name="citrix-cycle-stations-layer" checked>Citrix Cycle Stations<br></div>
            <div id="legend-lines">
                <svg height="10" width="100" class="greenway-legend">
                    <line x1="0" y1="5" x2="100" y2="5"/>
                </svg>
                <br>
                <svg height="10" width="100" class="greenway-legend">
                    <line x1="0" y1="5" x2="20" y2="5"/>
                    <line x1="40" y1="5" x2="60" y2="5"/>
                    <line x1="80" y1="5" x2="100" y2="5"/>
                </svg>
            </div> -->
        </div>
    </div>
    <div id="map"></div>
    <!-- <div id="footer">
        <div id="keyTitle">Key</div>
        <div id="key">
            <div id="greenways" class="keyEle">Greenways</div>
            <div id="existing" class="keyEle">Existing (sharrows dashed)</div>
            <div id="programmed" class="keyEle">Programmed (sharrows dashed)</div>
            <div id="citrix" class="keyEle">Citrix Cycle</div>
        </div>
    </div> -->
</body>

<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoicGV0ZXJib3llciIsImEiOiJjanF5aHpuYXAwMGhvNDl0MmRkN3F2cHpxIn0.cdJjFtN1PHLcMZTlGC1WNg'
    

    const citrixColor = '#f9423a';
    const programmedFacilitiesColor = '#3498DB';
    const greenwayColor = '#28B463';

    const layers = {
        EXISTING: "existing-bike-facilities-layer",
        EXISITING_DASHED: "existing-bike-facilities-dashed-layer",
        PROGRAMMED: "programmed-bike-facilities-layer",
        PROGRAMMED_DASHED: "programmed-bike-facilities-dashed-layer",
        GREENWAY: "existing-greenways-layer",
        GREENWAY_DASHED: "existing-greenways-dashed-layer",
        CITRIX: 'citrix-cycle-stations-layer',
    }


    let map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/peterboyer/cjr49i1ql0mza2srxxtgqlpqw',
        center: [-78.638176, 35.779591],
        zoom: 12
    });

    map.addControl(new mapboxgl.GeolocateControl({
        positionOptions: {
            enableHighAccuracy: true
        },
        trackUserLocation: true
    }),'bottom-right');

    map.addControl(new mapboxgl.NavigationControl());

    // Function to help build a query string for querying the ArcGIS REST service
    function queryString(queryProperties) {
        let queryString = '';
        for (let property in queryProperties) {
            queryString += `${property}=${queryProperties[property].toString()}&`
        }
        return queryString.slice(0, -1)
    }

    // REST endpoint for a dataset published to an ArcGIS Server. In this case, it was published to an ArcGIS Online ArcGIS Server 
    let existingGreenwaysURL = 'https://services.arcgis.com/v400IkDOw1ad7Yad/ArcGIS/rest/services/Greenway_Trails_All/FeatureServer/0';
    let existingBikeFacilities = 'https://services.arcgis.com/v400IkDOw1ad7Yad/ArcGIS/rest/services/Existing_Bike_Facilities/FeatureServer/6';
    let programmedBikeFacilities = 'https://services.arcgis.com/v400IkDOw1ad7Yad/ArcGIS/rest/services/Programmed_Bike_Facilities/FeatureServer/6';
    let citrixCycleStations = 'https://services.arcgis.com/v400IkDOw1ad7Yad/arcgis/rest/services/Citrix_Cycle_Stations/FeatureServer/0';

    // Create the query string. These are the minimum parameters needed to return valid GeoJSON of a dataset, but addtional parameters could be added to refine the query
    let queryParams = queryString({
        where: "1=1",
        outSR: 4326,
        outFields: "*",
        f: "geojson"
    }); 

    let citrixQuery = queryString({
        where: "status LIKE 'open'",
        outSR: 4326,
        outFields: "*",
        f: "geojson"
    });

    // Generate the full query URL
    let existingGreenwaysQuery = `${existingGreenwaysURL}/query?${queryParams}`;
    let existingBikeFacilitiesQuery = `${existingBikeFacilities}/query?${queryParams}`;
    let programmedBikeFacilitiesQuery = `${programmedBikeFacilities}/query?${queryParams}`;
    let citrixCycleStationsQuery = `${citrixCycleStations}/query?${citrixQuery}`;

    map.on('load', () => {
        map.addSource('existing-bike-facilities', {
            'type': 'geojson',
            'data': existingBikeFacilitiesQuery
        });

        map.addLayer({
            'id': layers.EXISTING,
            'type': 'line',
            'source': 'existing-bike-facilities',
            'layout': {},
            'paint': {
                'line-color': [
                    'match',
                    ['get', 'Type'],
                    'Bike Lane', 'white',
                    'Bike Lane/Shared Lane Markings', 'white',
                    'Buffered Bike Lane', 'white',
                    'Buffered Bike Lane/Bike Lane', 'white',
                    'Buffered Bike Lane/Shared Lane Markings', 'white',
                    'Separated Bike Lane', 'white',
                    'Multi-Use Path', 'white',
                    // 'Neighborhood Bikeway', 'green',
                    // 'Shared Lane Markings', 'aqua',
                    // 'Unknown', 'red',
                    'grey'
                ],
                'line-width': [
                    'match',
                    ['get', 'Type'],
                    'Bike Lane', 1.5,
                    'Bike Lane/Shared Lane Markings', 1.5,
                    'Buffered Bike Lane', 2,
                    'Buffered Bike Lane/Bike Lane', 2,
                    'Buffered Bike Lane/Shared Lane Markings', 2,
                    'Separated Bike Lane', 2,
                    'Multi-Use Path', 1.5,
                    // 'Neighborhood Bikeway', 1.5,
                    // 'Shared Lane Markings', 1.5,
                    // 'Unknown', 1.5,
                    0
                ]
            }
        });

        map.addLayer({
            'id': layers.EXISITING_DASHED,
            'type': 'line',
            'source': 'existing-bike-facilities',
            'layout': {},
            'paint': {
                'line-color': [
                    'match',
                    ['get', 'Type'],
                    // 'Bike Lane', 'blue',
                    // 'Bike Lane/Shared Lane Markings', 'cyan',
                    // 'Buffered Bike Lane', 'magenta',
                    // 'Buffered Bike Lane/Bike Lane', 'yellow',
                    // 'Buffered Bike Lane/Shared Lane Markings', 'white',
                    // 'Separated Bike Lane', 'blue',
                    'Neighborhood Bikeway', '#eee',
                    // 'Multi-Use Path', '#eee',
                    'Shared Lane Markings', '#eee',
                    'Unknown', '#eee',
                    'grey'
                ],
                'line-width': [
                    'match',
                    ['get', 'Type'],
                    // 'Bike Lane', 1.5,
                    // 'Bike Lane/Shared Lane Markings', 1.5,
                    // 'Buffered Bike Lane', 1.5,
                    // 'Buffered Bike Lane/Bike Lane', 1.5,
                    // 'Buffered Bike Lane/Shared Lane Markings', 1.5,
                    // 'Separated Bike Lane', 1.5,
                    'Neighborhood Bikeway', 1.5,
                    // 'Multi-Use Path', 1.5,
                    'Shared Lane Markings', 1.5,
                    'Unknown', 1.5,
                    0
                ],
                'line-dasharray': [1,2]
            }
        });

        map.addSource('programmed-bike-facilities', {
            'type': 'geojson',
            'data': programmedBikeFacilitiesQuery
        });

        map.addLayer({
            'id': layers.PROGRAMMED,
            'type': 'line',
            'source': 'programmed-bike-facilities',
            'layout': {},
            'paint': {
                'line-color': [
                    'match',
                    ['get', 'Type'],
                    'Bike Lane', programmedFacilitiesColor,
                    'Bike Lane/Shared Lane Markings', programmedFacilitiesColor,
                    'Buffered Bike Lane', programmedFacilitiesColor,
                    'Buffered Bike Lane/Bike Lane', programmedFacilitiesColor,
                    'Buffered Bike Lane/Shared Lane Markings', programmedFacilitiesColor,
                    'Separated Bike Lane', programmedFacilitiesColor,
                    'Multi-Use Path', programmedFacilitiesColor,
                    // 'Neighborhood Bikeway', programmedFacilitiesColor,
                    // 'Shared Lane Markings', programmedFacilitiesColor,
                    // 'Unknown', programmedFacilitiesColor,
                    'grey'
                ],
                'line-width': [
                    'match',
                    ['get', 'Type'],
                    'Bike Lane', 1.5,
                    'Bike Lane/Shared Lane Markings', 1.5,
                    'Buffered Bike Lane', 2,
                    'Buffered Bike Lane/Bike Lane', 2,
                    'Buffered Bike Lane/Shared Lane Markings', 2,
                    'Separated Bike Lane', 2,
                    'Multi-Use Path', 1.5,
                    // 'Neighborhood Bikeway', 1.5,
                    // 'Shared Lane Markings', 1.5,
                    // 'Unknown', 1.5,
                    0
                ]
            }
        });

        map.addLayer({
            'id': layers.PROGRAMMED_DASHED,
            'type': 'line',
            'source': 'programmed-bike-facilities',
            'layout': {},
            'paint': {
                'line-color': [
                    'match',
                    ['get', 'Type'],
                    // 'Bike Lane', '#eee',
                    // 'Bike Lane/Shared Lane Markings', '#eee',
                    // 'Buffered Bike Lane', '#eee',
                    // 'Buffered Bike Lane/Bike Lane', '#eee',
                    // 'Buffered Bike Lane/Shared Lane Markings', '#eee',
                    // 'Separated Bike Lane', '#eee',
                    // 'Multi-Use Path', '#eee',
                    'Neighborhood Bikeway', programmedFacilitiesColor,
                    'Shared Lane Markings', programmedFacilitiesColor,
                    'Unknown', programmedFacilitiesColor,
                    'grey'
                ],
                'line-width': [
                    'match',
                    ['get', 'Type'],
                    // 'Bike Lane', 1.5,
                    // 'Bike Lane/Shared Lane Markings', 1.5,
                    // 'Buffered Bike Lane', 1.5,
                    // 'Buffered Bike Lane/Bike Lane', 1.5,
                    // 'Buffered Bike Lane/Shared Lane Markings', 1.5,
                    // 'Separated Bike Lane', 1.5,
                    'Neighborhood Bikeway', 1.5,
                    // 'Multi-Use Path', 1.5,
                    'Shared Lane Markings', 1.5,
                    'Unknown', 1.5,
                    0
                ],
                'line-dasharray': [1,2]
            }
        });

        map.addSource('existing-greenways', {
            'type': 'geojson',
            'data': existingGreenwaysQuery
        });

        map.addLayer({
            'id': layers.GREENWAY,
            'type': 'line',
            'source': 'existing-greenways',
            'layout': {},
            'paint': {
                'line-color': [
                    'match',
                    ['get', 'TYPE'],
                    'Trail', greenwayColor,
                    'Crossing', greenwayColor,
                    'Structure', greenwayColor,
                    'grey'
                ],
                'line-width': [
                    'match',
                    ['get', 'TYPE'],
                    'Trail', 1.5,
                    'Crossing', 1.5,
                    'Structure', 1.5,
                    0
                ],
                'line-opacity': [
                    'match',
                    ['get', 'WIDTH_FT'],
                    1, 0,
                    2, 0,
                    3, 0,
                    4, 0,
                    5, 0,
                    6, 0,
                    1
                ]
            }
        });
        
        // We are using greenway width as a guess as to how bikable a section
        // of greenway is.  If it is less than 7 ft wide we assume it is not easily bikeable
        // and make it dashed
        map.addLayer({
            'id': layers.GREENWAY_DASHED,
            'type': 'line',
            'source': 'existing-greenways',
            'layout': {},
            'paint': {
                'line-color': greenwayColor,
                'line-width': [
                    'match',
                    ['get', 'TYPE'],
                    'Trail', 1.5,
                    'Crossing', 1.5,
                    'Structure', 1.5,
                    0
                ],
                'line-opacity': [
                    'match',
                    ['get', 'WIDTH_FT'],
                    1, 1,
                    2, 1,
                    3, 1,
                    4, 1,
                    5, 1,
                    6, 1,
                    0
                ],
                'line-dasharray': [1,2]
            }
        });


        map.addSource('citrix-cycle-stations', {
            'type': 'geojson',
            'data': citrixCycleStationsQuery
        });

        map.addLayer({
            'id': layers.CITRIX,
            'type': 'circle',
            'source': 'citrix-cycle-stations',
            'layout': {},
            'paint': {
                'circle-color': citrixColor,
                'circle-radius': 4,
            }
        });

        map.resize();
    });

    function legendToggleLayer(ele) {
        var layerName = ele.name;
        var visibilityState = ele.checked ? 'visible' : 'none';

        map.setLayoutProperty(layerName,'visibility',visibilityState);
    }

    function toggleLegend() {
        var legendBox = document.getElementById("legend-box");
        var isVisible = legendBox.style.visibility == 'visible';
        var newVisibilityState = isVisible ? 'hidden' : 'visible';

        legendBox.style.visibility = newVisibilityState;
    }
</script>

</html>
